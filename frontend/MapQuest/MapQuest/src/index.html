<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />

    <!--map references-->
    <script src="https://api.mqcdn.com/sdk/mapquest-js/v1.3.2/mapquest.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <link type="text/css" rel="stylesheet" href="https://api.mqcdn.com/sdk/mapquest-js/v1.3.2/mapquest.css" />

    <!--search references-->
    <script src="https://api.mqcdn.com/sdk/place-search-js/v1.0.0/place-search.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <link type="text/css" rel="stylesheet" href="https://api.mqcdn.com/sdk/place-search-js/v1.0.0/place-search.css" />
    <link rel="stylesheet" href="main.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-eOJMYsd53ii+scO/bJGFsiCZc+5NDVN2yr8+0RDqr0Ql0h+rP48ckxlpbzKgwra6" crossorigin="anonymous">

    <link type="text/javascript" rel="stylesheet" href="https://api.mqcdn.com/sdk/place-search-js/v1.0.0/place-search.css" />

    <title>Rideshare Comparator</title>

    <!--place.js code-->
    <script type="text/javascript">
        window.onload = function () {
            placeSearch({
                key: 'ObOOcgLBayNvuhkFMUAKvmh5y7pXteON',                   // 'h9DlTmYOaKmZVdyDa1Z6qFu1X1tDawOW',
                container: document.querySelector('#search-input'),
                useDeviceLocation: true,
                collection: [
                    'poi',
                    'airport',
                    'address',
                    'adminArea',
                ]
            });
            placeSearch({
                key: 'ObOOcgLBayNvuhkFMUAKvmh5y7pXteON',                   // 'h9DlTmYOaKmZVdyDa1Z6qFu1X1tDawOW',
                container: document.querySelector('#destination-input'),
                useDeviceLocation: true,
                collection: [
                    'poi',
                    'airport',
                    'address',
                    'adminArea',
                ]
            })
        }
    </script>

    <!--define the style for the map-->
    <style>
        #map {
            height: 750px;
        }
    </style>

</head>

<body style="border: 0; margin: 40px;">

    <!--style table-->
    <style>
        th {
            color: #fff;
        }
    </style>

    <!--prompt user input-->
    <span class = "wrapper">
        <input type="search" id="search-input" placeholder="Start Point..." />
        <input type="search" id="destination-input" placeholder="Destination..." /><br><br>
        <input type="submit" onclick="getInput();" />
        <input type="reset" onclick="reset();"><br><br>

        <!--<form id="prompt" onsubmit="return false;">
            <input placeholder="Starting Location" type="text" id="userStart" />
            <input placeholder="Destination" type="text" id="userEnd" />
            <input type="submit" onclick="getInput();" />
        </form>-->

        <!--build map-->
        <div style="margin: 40px", id="map"></div>
    </span>
    

    <div id = "isaboveaverage"></div>
    
    <!--Table Headers-->
    <table class="table table-striped">
        <tr class="bg-info">
            <th data-column="provider" data-order="desc">Provider &#9650</th>
            <th data-column="name" data-order="desc">Name &#9650</th>
            <th data-column="pickup" data-order="desc">Pickup &#9650</th>
            <th data-column="arrival" data-order="desc">Arrival &#9650</th>
            <th data-column="price" data-order="desc">Price &#9650</th>
            <th data-column="seats" data-order="desc">Seats &#9650</th>
            <th data-column="shared" data-order="desc">Shared &#9650</th>
        </tr>

        <tbody id="myTable">
        </tbody>
    </table>

    <!--reset button-->
    <input type="reset" onclick="reset();" />

    <!-------------------------------------------------------------------------------------------------------------------------------------------------------------->

    <!--Scripts to build the map and produce a route-->
    <script>
        L.mapquest.key = 'ObOOcgLBayNvuhkFMUAKvmh5y7pXteON';
        const api_url = 'http://127.0.0.1:5000/';

        var results;
        var isaboveaverage;
      
        // create the map
        var map = L.mapquest.map('map', {
            center: [41.5043, -81.6084],
            layers: L.mapquest.tileLayer('map'),
            zoom: 12
        });
        map.addControl(L.mapquest.control());

        // create map plotter
        var routeDeveloper = L.mapquest.directions();
        routeDeveloper.setLayerOptions({
            startMarker: {
                draggable: false,
                iconOptions: {
                    size: 'md'
                }
            },
            endMarker: {
                draggable: false,
                iconOptions: {
                    size: 'md'
                }
            },
            waypointMarker: {
                draggable: false,
                icon: 'circle',
                iconOptions: {
                    size: 'sm',
                    primaryColor: '#dcf0ef',
                    secondaryColor: '#dcf0ef'
                },
                title: ''
            },
            routeRibbon: {
                draggable: false,
                opacity: 1.0,
                showTraffic: false
            },
            alternateRouteRibbon: {
                opacity: 1.0
            },
        });

        // change user input into latitude and longitude cordinates through Geocoding API provided by MapQuest
        const geocode_url = "http://www.mapquestapi.com/geocoding/v1/address";
        function getLatLon(startLoc, destLoc) {
            var startLat, startLon, endLat, endLon;
            axios.get(geocode_url, {
                params: {
                    key: 'ObOOcgLBayNvuhkFMUAKvmh5y7pXteON',
                    location: startLoc
                }
            })
            .then(function(response) {
                console.log(response);
                // save starting location's latitude and longitude cordinates
                startLat = response.data.results[0].locations[0].latLng.lat;
                startLon = response.data.results[0].locations[0].latLng.lng;
            })
            .catch(function(error) {
                console.log(error);
                alert("Please Enter a Valid Address");
            });

            axios.get(geocode_url, {
                params: {
                    key: 'ObOOcgLBayNvuhkFMUAKvmh5y7pXteON',
                    location: destLoc
                }
            })
            .then(function(response) {
                console.log(response);
                // save destinations latitude and longitude cordinates
                endLat = response.data.results[0].locations[0].latLng.lat;
                endLon = response.data.results[0].locations[0].latLng.lng;
            })
            .then(function(response) {
                var startCord = [startLat, startLon];
                var endCord = [endLat, endLon];
                console.log("starting cords: " + startCord);
                console.log("destination cords: " + endCord);
                getData(startLat, startLon, endLat, endLon);
                })
                .catch(function(error) {
                    console.log(error);
                    alert("Please Enter A Valid Address");
                });
        }

        function getData(sLat, sLon, eLat, eLon) {
            axios.get(api_url, {
                params: {
                    srclat: sLat,
                    srclon: sLon,
                    destlat: eLat,
                    destlon: eLon
                }
            })
            .then(function(response){
                console.log(response);
                routing(response);
                buildAboveAverage(response);
                buildTable(response);
            })
            .catch(function(error) {
                console.log(error);
                alert(error);
            })
        }

        // get the maneuver points of route provided by local API
        function routing(apiResponse) {
            var maneuverComponents = apiResponse.data.path.legs[0].maneuvers;
            var routeComponentsLat = [];
            var routeComponentsLon = [];
            for(var i = 0; i < maneuverComponents.length; i++) {
                routeComponentsLat[i] = maneuverComponents[i].startPoint.lat;
                routeComponentsLon[i] = maneuverComponents[i].startPoint.lng;
                var maneuverCord = [routeComponentsLat[i], routeComponentsLon[i]];
                console.log("maneuver " + i + " at " + maneuverCord);
            }
            plotRoute(routeComponentsLat, routeComponentsLon);
        }

        // plot maneuver points on map to display route
        function plotRoute(rLats, rLons) {
            var maneuverList = [];

            for(var i = 1; i < rLats.length - 1; i++) {
                maneuverList[i] = L.latLng([rLats[i], rLons[i]]);
            }

            routeDeveloper.route({
                start: L.latLng([rLats[0], rLons[0]]),
                end: L.latLng([rLats[rLats.length - 1], rLons[rLons.length - 1]]),
                waypoints: maneuverList
            });
        }

        // grabs the user's input
        function getInput() {
            var startInput = document.getElementById("search-input").value;
            var endInput = document.getElementById("destination-input").value;
            getLatLon(startInput, endInput);
        }

        // refresh the page
        function reset() {
            location.reload();
        }

/*-------Scripts for building HTML table with JSON Data---------------------------------------------------------------------------------------------------------------------------------------------------------------*/
   
        /*table sorting functionality*/
        $('th').on('click', function () {
            var column = $(this).data('column')
            var order = $(this).data('order')
            var text = $(this).html()
            text = text.substring(0, text.length - 1)


            if (order == 'desc') {
                $(this).data('order', "asc")
                results = results.sort((a, b) => a[column] > b[column] ? 1 : -1)
                text += '&#9660'
            } else {
                $(this).data('order', "desc")
                results = results.sort((a, b) => a[column] < b[column] ? 1 : -1)
                text += '&#9650'
            }
            $(this).html(text)
            buildTable(results)
        })

        /*Function that Builds the Div from above average array*/
        function buildAboveAverage(aboveAverage) {
            var div = document.getElementById('isaboveaverage')
            if(aboveAverage === true){
                div.innerHTML = '<h2>Prices are currently above average</h2>'
            }
            else{
                div.innerHTML = '<h2>Prices are currently normal</h2>'
            }
        }

        /*Function that Builds the Table from JSON array*/
        function buildTable(output) {
            var table = document.getElementById('myTable');
            table.innerHTML = '';
            for (var i = 0; i < output.data.results.length; i++) {    
                console.log("reading result: " + i);
                    var row = ` <tr>
                                            <td> ${output.data.results[i].provider}</td>
                                            <td> ${output.data.results[i].name}</td>
                                            <td> ${output.data.results[i].pickup}</td>
                                            <td> ${output.data.results[i].arrival}</td>
                                            <td> ${output.data.results[i].price}</td>
                                            <td> ${output.data.results[i].seats}</td>
                                            <td> ${output.data.results[i].shared}</td>
                                        </tr>`
                table.innerHTML += row
            }
        }
        
    </script>
</body>
</html>